<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMI Calculator - Advance Credit | Smart Debt Planning & Consolidation</title>
    <meta name="description" content="Plan your debt consolidation with our advanced EMI calculator. Calculate monthly payments, total interest, and discover strategies to save money on your loans.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --accent-blue: #1e40af;
            --light-blue: #dbeafe;
            --white: #ffffff;
            --dark-text: #1f2937;
            --gray-text: #6b7280;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--dark-text);
            background: var(--white);
            line-height: 1.6;
        }
        
        .navbar {
            background: var(--white) !important;
            box-shadow: 0 2px 10px rgba(30, 58, 138, 0.1);
            border-bottom: 1px solid #e5e7eb;
        }
        
        .navbar-brand {
            color: var(--primary-blue) !important;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: var(--dark-text) !important;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .nav-link:hover {
            color: var(--secondary-blue) !important;
        }
        
        .btn-primary {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: var(--white);
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }
        
        .btn-outline-primary {
            color: var(--primary-blue);
            border-color: var(--primary-blue);
            font-weight: 600;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .text-primary {
            color: var(--primary-blue) !important;
        }
        
        .bg-primary {
            background: var(--primary-blue) !important;
        }
        
        .bg-light-blue {
            background: var(--light-blue);
        }
        
        .text-accent { 
            color: var(--primary-blue) !important; 
        }
        
        .btn-accent { 
            background: var(--primary-blue) !important; 
            color: var(--white) !important; 
            border: none; 
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .btn-accent:hover, .btn-accent:focus { 
            background: var(--accent-blue) !important; 
            color: var(--white) !important; 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }
        
        .accent-fill { 
            fill: var(--primary-blue) !important; 
        }
        
        .glass-card {
            background: var(--white);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            padding: 2rem;
        }
        
        .glass-card:hover {
            box-shadow: 0 8px 25px rgba(30, 58, 138, 0.15);
            transform: translateY(-2px);
        }
        
        .hero-section {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-blue) 100%);
            color: var(--white);
            padding: 80px 0;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 3rem;
        }
        
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }
        
        .form-control {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .form-range {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }
        
        .form-range::-webkit-slider-thumb {
            background: var(--primary-blue);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
        }
        
        .form-range::-moz-range-thumb {
            background: var(--primary-blue);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 4px rgba(30, 58, 138, 0.3);
        }
        
        .result-card {
            background: var(--light-blue);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 2px solid var(--primary-blue);
        }
        
        .value-proposition {
            background: var(--white);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .value-proposition:hover {
            box-shadow: 0 8px 25px rgba(30, 58, 138, 0.15);
            transform: translateY(-2px);
        }
        
        .footer-dark { 
            background: var(--dark-text); 
            color: var(--white);
        }
        
        .savings-highlight {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .warning-highlight {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #d97706 100%);
            color: var(--white);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        @media (max-width: 767px) { 
            .glass-card { border-radius: 8px; } 
        }
    </style>
</head>
<body>
{% include 'navbar.html' %}

<div class="page-content">
    <div class="container mt-5">
        <!-- Hero Section -->
        <section class="hero-section position-relative">
            <div class="container position-relative">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="animate__animated animate__fadeInLeft">
                            <h1 class="display-4 fw-bold mb-3">Smart EMI Planning</h1>
                            <p class="lead mb-4">Plan your debt consolidation with precision. Calculate EMIs, understand total costs, and discover strategies to save thousands on interest payments.</p>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Accurate Calculations</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Early Repayment Tips</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span>Interest Savings Guide</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="text-center animate__animated animate__fadeInRight">
                            <i class="bi bi-calculator text-white" style="font-size: 8rem; opacity: 0.8;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Value Propositions -->
        <section class="row mb-5">
            <div class="col-md-4 mb-4">
                <div class="value-proposition text-center h-100">
                    <i class="bi bi-graph-up text-primary mb-3" style="font-size: 3rem;"></i>
                    <h5 class="fw-bold mb-3">Debt Consolidation Planning</h5>
                    <p class="text-muted">Calculate EMIs for multiple loans and plan your consolidation strategy to reduce monthly payments.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="value-proposition text-center h-100">
                    <i class="bi bi-piggy-bank text-primary mb-3" style="font-size: 3rem;"></i>
                    <h5 class="fw-bold mb-3">Interest Savings Calculator</h5>
                    <p class="text-muted">Discover how extra payments can save you thousands in interest and shorten your loan tenure.</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="value-proposition text-center h-100">
                    <i class="bi bi-shield-check text-primary mb-3" style="font-size: 3rem;"></i>
                    <h5 class="fw-bold mb-3">Financial Health Assessment</h5>
                    <p class="text-muted">Understand your debt-to-income ratio and plan for better financial stability.</p>
                </div>
            </div>
        </section>

        <!-- EMI Calculator Form -->
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="glass-card">
                    <h3 class="text-center mb-4 text-primary">EMI Calculator</h3>
                    <form id="emiCalculatorForm">
                        <div class="mb-4">
                            <label for="loan_amount" class="form-label fw-semibold text-primary">Loan Amount (â‚¹)</label>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-cash-stack me-2 text-primary"></i>
                                <input type="range" class="form-range flex-grow-1" id="loan_amount_slider" min="10000" max="100000000" step="1000" value="{{ result.loan_amount if result else 500000 }}" oninput="loanAmountOutput.value = this.value">
                                <input type="number" class="form-control ms-3" id="loan_amount" name="loan_amount" min="10000" max="100000000" step="1000" style="width:180px;" value="{{ result.loan_amount if result else 500000 }}" oninput="loan_amount_slider.value = this.value; loanAmountOutput.value = this.value">
                                <output id="loanAmountOutput" style="display:none;"></output>
                            </div>
                            <div class="text-end small text-muted mt-1">Min: â‚¹10,000 &nbsp; Max: â‚¹10,00,00,000</div>
                        </div>
                        <div class="mb-4">
                            <label for="interest_rate" class="form-label fw-semibold text-primary">Interest Rate (% p.a.)</label>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-percent me-2 text-primary"></i>
                                <input type="range" class="form-range flex-grow-1" id="interest_rate_slider" min="6" max="30" step="0.1" value="{{ result.interest_rate if result else 10 }}" oninput="interestRateOutput.value = this.value">
                                <input type="number" class="form-control ms-3" id="interest_rate" name="interest_rate" min="6" max="30" step="0.1" style="width:90px;" value="{{ result.interest_rate if result else 10 }}" oninput="interest_rate_slider.value = this.value; interestRateOutput.value = this.value">
                                <span class="ms-2">%</span>
                            </div>
                            <div class="text-end small text-muted mt-1">Min: 6% &nbsp; Max: 30%</div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-semibold text-primary">Tenure</label>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar2-week me-2 text-primary"></i>
                                <input type="range" class="form-range flex-grow-1" id="tenure_slider" min="1" max="30" step="1" value="{{ result.tenure if result else 5 }}" oninput="updateTenureOutput()">
                                <input type="number" class="form-control ms-3" id="tenure" name="tenure" min="1" max="360" step="1" style="width:90px;" value="{{ result.tenure if result else 5 }}" oninput="tenure_slider.value = this.value; updateTenureOutput()">
                                <div class="form-check form-switch ms-3">
                                    <input class="form-check-input" type="checkbox" id="tenureUnitToggle" onchange="toggleTenureUnit()">
                                    <label class="form-check-label" for="tenureUnitToggle" id="tenureUnitLabel">Years</label>
                                </div>
                            </div>
                            <div id="tenure-numbers" class="d-flex justify-content-between px-1 mt-2 text-muted small flex-wrap" style="font-variant-numeric: tabular-nums; max-width:100%; overflow-x:auto;"></div>
                            <div class="text-end small text-muted mt-1">1â€“30 Years or 12â€“360 Months</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg mt-3" id="calculateEmiBtn">
                            <span class="btn-text">Calculate EMI</span>
                            <span class="btn-loading d-none">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Calculating...
                            </span>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {% if result %}
        <!-- Results Section -->
        <div class="row justify-content-center mt-5">
            <div class="col-md-8 col-lg-6">
                <div class="result-card animate__animated animate__fadeInUp">
                    <div class="text-center mb-4">
                        <i class="bi bi-calculator text-primary mb-3" style="font-size: 3rem;"></i>
                        <h4 class="fw-bold text-primary mb-2">Your EMI Breakdown</h4>
                        <div class="display-6 fw-bold text-primary">â‚¹{{ result.emi }}</div>
                        <p class="text-muted">Monthly Payment</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="fw-bold text-primary">Total Payable</div>
                                <div class="fs-5 fw-bold">â‚¹{{ result.total_payment }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3 bg-light rounded">
                                <div class="fw-bold text-primary">Total Interest</div>
                                <div class="fs-5 fw-bold">â‚¹{{ result.total_interest }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-6">
                            <div class="text-center p-2">
                                <div class="small text-muted">Loan Amount</div>
                                <div class="fw-bold">â‚¹{{ result.loan_amount }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2">
                                <div class="small text-muted">Tenure</div>
                                <div class="fw-bold">{{ result.tenure }} months</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <span class="badge bg-primary fs-6">Interest Rate: {{ result.interest_rate }}% p.a.</span>
                    </div>
                    
                    <!-- Chart -->
                    <div class="bg-light rounded p-3 mb-4">
                        <canvas id="emiPieChart" width="320" height="220" 
                                data-loan-amount="{{ result.loan_amount.replace(',', '') if result else 0 }}"
                                data-total-interest="{{ result.total_interest.replace(',', '') if result else 0 }}"
                                data-emi="{{ result.emi.replace(',', '') if result else 0 }}"
                                data-tenure="{{ result.tenure if result else 0 }}"
                                data-interest-rate="{{ result.interest_rate if result else 0 }}"></canvas>
                    </div>
                    
                    <!-- Early Repayment Tips -->
                    <div class="bg-light rounded p-4">
                        <h5 class="text-primary mb-3">ðŸ’¡ Smart Repayment Strategies</h5>
                        <div class="savings-highlight">
                            <h6 class="mb-2"><i class="bi bi-lightbulb me-2"></i>Save Big with Extra Payments</h6>
                            <p class="mb-0">Even 1-2 extra EMIs per year can save you lakhs in interest and reduce your loan tenure significantly.</p>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="mb-3">Interest Savings by Paying Extra EMIs per Year</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Extra EMIs/Year</th>
                                            <th>New Tenure (months)</th>
                                            <th>New Total Interest (â‚¹)</th>
                                            <th>Interest Saved (â‚¹)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="emi-savings-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="warning-highlight mt-4">
                            <h6 class="mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Important Tips</h6>
                            <ul class="mb-0">
                                <li>Make part-prepayments whenever possible to reduce outstanding principal</li>
                                <li>Pay extra EMIs each year to shorten loan tenure</li>
                                <li>Consider debt consolidation if you have multiple high-interest loans</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Additional Services Section -->
        <section class="row mt-5">
            <div class="col-12">
                <h3 class="text-center mb-4 text-primary">Need Help with Debt Management?</h3>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="glass-card text-center h-100">
                            <i class="bi bi-people text-primary mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold mb-3">Free Consultation</h5>
                            <p class="text-muted">Get personalized advice from our financial experts on debt consolidation and management.</p>
                            <a href="/contact" class="btn btn-outline-primary">Get Free Consultation</a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="glass-card text-center h-100">
                            <i class="bi bi-graph-up-arrow text-primary mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold mb-3">Debt Consolidation</h5>
                            <p class="text-muted">Combine multiple high-interest loans into one manageable payment with lower interest rates.</p>
                            <a href="/services" class="btn btn-outline-primary">Learn More</a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="glass-card text-center h-100">
                            <i class="bi bi-shield-check text-primary mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold mb-3">Credit Score Improvement</h5>
                            <p class="text-muted">Improve your credit score with our proven strategies and debt management plans.</p>
                            <a href="/products" class="btn btn-outline-primary">Explore Options</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- Loan Amount Slider Sync ---
const loanAmountSlider = document.getElementById('loan_amount_slider');
const loanAmountInput = document.getElementById('loan_amount');
if (loanAmountSlider && loanAmountInput) {
    loanAmountSlider.addEventListener('input', function() {
        loanAmountInput.value = this.value;
    });
    loanAmountInput.addEventListener('input', function() {
        loanAmountSlider.value = this.value;
    });
}

// --- Interest Rate Slider Sync ---
const interestRateSlider = document.getElementById('interest_rate_slider');
const interestRateInput = document.getElementById('interest_rate');
if (interestRateSlider && interestRateInput) {
    interestRateSlider.addEventListener('input', function() {
        interestRateInput.value = this.value;
    });
    interestRateInput.addEventListener('input', function() {
        interestRateSlider.value = this.value;
    });
}

// --- Tenure Slider & Toggle ---
const tenureSlider = document.getElementById('tenure_slider');
const tenureInput = document.getElementById('tenure');
const tenureUnitToggle = document.getElementById('tenureUnitToggle');
const tenureUnitLabel = document.getElementById('tenureUnitLabel');

function updateTenureOutput() {
    if (tenureUnitToggle && tenureUnitToggle.checked) {
        // Months
        tenureInput.value = tenureSlider.value;
    } else {
        // Years
        tenureInput.value = tenureSlider.value;
    }
}

function toggleTenureUnit() {
    if (tenureUnitToggle.checked) {
        tenureUnitLabel.textContent = 'Months';
        tenureSlider.min = 12;
        tenureSlider.max = 360;
        tenureSlider.step = 1;
        tenureSlider.value = 60;
        tenureInput.value = 60;
    } else {
        tenureUnitLabel.textContent = 'Years';
        tenureSlider.min = 1;
        tenureSlider.max = 30;
        tenureSlider.step = 1;
        tenureSlider.value = 5;
        tenureInput.value = 5;
    }
}

if (tenureUnitToggle) {
    tenureUnitToggle.addEventListener('change', toggleTenureUnit);
    toggleTenureUnit();
}

if (tenureSlider && tenureInput) {
    tenureSlider.addEventListener('input', function() {
        tenureInput.value = this.value;
    });
    tenureInput.addEventListener('input', function() {
        tenureSlider.value = this.value;
    });
}

// Pie Chart
const emiPieChart = document.getElementById('emiPieChart');
if (emiPieChart) {
    const ctx = emiPieChart.getContext('2d');
    
    // Create gradients
    const gradPrincipal = ctx.createLinearGradient(0, 0, 0, 220);
    gradPrincipal.addColorStop(0, '#dbeafe');
    gradPrincipal.addColorStop(0.4, '#3b82f6');
    gradPrincipal.addColorStop(1, '#1e3a8a');
    
    const gradInterest = ctx.createLinearGradient(0, 0, 320, 220);
    gradInterest.addColorStop(0, '#fef3c7');
    gradInterest.addColorStop(0.5, '#f59e0b');
    gradInterest.addColorStop(1, '#d97706');
    
    // Get data from canvas attributes
    const loanAmount = parseInt(emiPieChart.dataset.loanAmount || 0);
    const totalInterest = parseInt(emiPieChart.dataset.totalInterest || 0);
    
    new Chart(emiPieChart, {
        type: 'pie',
        data: {
            labels: ['Principal', 'Interest'],
            datasets: [{
                data: [loanAmount, totalInterest],
                backgroundColor: [gradPrincipal, gradInterest],
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 16
            }]
        },
        options: {
            plugins: {
                legend: { 
                    labels: { 
                        color: '#1f2937', 
                        font: { size: 14, weight: 'bold' } 
                    } 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return `${label}: â‚¹${value.toLocaleString()}`;
                        }
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            animation: { animateRotate: true, animateScale: true }
        }
    });
}

// Early Repayment Table Calculation
function calculateEarlyRepayment(P, n, r, emi, maxExtra, totalInterest) {
    let results = [];
    for (let extra = 1; extra <= maxExtra; extra++) {
        let months = 0, principal = P, totalInt = 0;
        while (principal > 0 && months < 1000) {
            let interest = principal * r;
            let payment = emi + (months % 12 < extra ? emi : 0);
            if (payment > principal + interest) payment = principal + interest;
            totalInt += interest;
            principal = principal + interest - payment;
            months++;
        }
        results.push({
            extra: extra,
            newTenure: months,
            newInterest: Math.round(totalInt),
            saved: Math.round(totalInterest - totalInt)
        });
    }
    return results;
}

document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.getElementById('emi-savings-tbody');
    const emiPieChart = document.getElementById('emiPieChart');
    
    if (tbody && emiPieChart && emiPieChart.dataset.loanAmount) {
        const P = parseInt(emiPieChart.dataset.loanAmount);
        const n = {{ result.tenure if result else 0 }};
        const r = {{ result.interest_rate if result else 0 }} / 12 / 100;
        const emi = parseInt(emiPieChart.dataset.emi || 0);
        const totalInterest = parseInt(emiPieChart.dataset.totalInterest);
        const maxExtra = 5;
        const results = calculateEarlyRepayment(P, n, r, emi, maxExtra, totalInterest);
        tbody.innerHTML = results.map(r => `<tr><td>${r.extra}</td><td>${r.newTenure}</td><td>â‚¹${r.newInterest.toLocaleString()}</td><td class='text-success fw-bold'>â‚¹${r.saved.toLocaleString()}</td></tr>`).join('');
    }
});

// --- Tenure Numbers Row ---
function renderTenureNumbers() {
    const container = document.getElementById('tenure-numbers');
    if (!container) return;
    container.innerHTML = '';
    if (tenureUnitToggle && tenureUnitToggle.checked) {
        // Months
        const marks = [0, 12, 60, 120, 180, 240, 300, 360];
        marks.forEach((m, i) => {
            const el = document.createElement('span');
            el.textContent = m;
            el.style.flex = '1';
            el.style.textAlign = 'center';
            el.style.minWidth = '32px';
            container.appendChild(el);
        });
    } else {
        // Years
        const marks = [0, 5, 10, 15, 20, 30];
        marks.forEach((y, i) => {
            const el = document.createElement('span');
            el.textContent = y;
            el.style.flex = '1';
            el.style.textAlign = 'center';
            el.style.minWidth = '32px';
            container.appendChild(el);
        });
    }
}

if (tenureUnitToggle) {
    tenureUnitToggle.addEventListener('change', function() {
        toggleTenureUnit();
        renderTenureNumbers();
    });
    renderTenureNumbers();
}

// EMI Calculator Form AJAX Submission
document.addEventListener('DOMContentLoaded', function() {
    const emiForm = document.getElementById('emiCalculatorForm');
    const calculateBtn = document.getElementById('calculateEmiBtn');
    const btnText = calculateBtn.querySelector('.btn-text');
    const btnLoading = calculateBtn.querySelector('.btn-loading');
    
    if (emiForm) {
        emiForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            calculateBtn.disabled = true;
            
            try {
                const formData = new FormData(emiForm);
                
                const response = await fetch('/emi', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const html = await response.text();
                    
                    // Create a temporary div to parse the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Find the results section in the response
                    const resultsSection = tempDiv.querySelector('.result-card');
                    
                    if (resultsSection) {
                        // Remove existing results if any
                        const existingResults = document.querySelector('.result-card');
                        if (existingResults) {
                            existingResults.remove();
                        }
                        
                        // Insert new results after the form
                        const formContainer = emiForm.closest('.col-md-8');
                        formContainer.parentNode.insertBefore(resultsSection, formContainer.nextSibling);
                        
                        // Scroll to results
                        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Reinitialize charts and calculations
                        initializeEMICalculations();
                    }
                } else {
                    console.error('Error calculating EMI');
                }
            } catch (error) {
                console.error('Error:', error);
            } finally {
                // Hide loading state
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                calculateBtn.disabled = false;
            }
        });
    }
});

// Function to reinitialize EMI calculations after AJAX update
function initializeEMICalculations() {
    // Reinitialize pie chart
    const emiPieChart = document.getElementById('emiPieChart');
    if (emiPieChart) {
        const ctx = emiPieChart.getContext('2d');
        
        // Create gradients
        const gradPrincipal = ctx.createLinearGradient(0, 0, 0, 220);
        gradPrincipal.addColorStop(0, '#dbeafe');
        gradPrincipal.addColorStop(0.4, '#3b82f6');
        gradPrincipal.addColorStop(1, '#1e3a8a');
        
        const gradInterest = ctx.createLinearGradient(0, 0, 320, 220);
        gradInterest.addColorStop(0, '#fef3c7');
        gradInterest.addColorStop(0.5, '#f59e0b');
        gradInterest.addColorStop(1, '#d97706');
        
        // Get data from canvas attributes
        const loanAmount = parseInt(emiPieChart.dataset.loanAmount || 0);
        const totalInterest = parseInt(emiPieChart.dataset.totalInterest || 0);
        
        new Chart(emiPieChart, {
            type: 'pie',
            data: {
                labels: ['Principal', 'Interest'],
                datasets: [{
                    data: [loanAmount, totalInterest],
                    backgroundColor: [gradPrincipal, gradInterest],
                    borderWidth: 2,
                    borderColor: '#ffffff',
                    hoverOffset: 16
                }]
            },
            options: {
                plugins: {
                    legend: { 
                        labels: { 
                            color: '#1f2937', 
                            font: { size: 14, weight: 'bold' } 
                        } 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                return `${label}: â‚¹${value.toLocaleString()}`;
                            }
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                animation: { animateRotate: true, animateScale: true }
            }
        });
    }
    
    // Reinitialize early repayment table
    const tbody = document.getElementById('emi-savings-tbody');
    if (tbody && emiPieChart && emiPieChart.dataset.loanAmount) {
        const P = parseInt(emiPieChart.dataset.loanAmount);
        const n = parseInt(emiPieChart.dataset.tenure || 0);
        const r = parseFloat(emiPieChart.dataset.interestRate || 0) / 12 / 100;
        const emi = parseInt(emiPieChart.dataset.emi || 0);
        const totalInterest = parseInt(emiPieChart.dataset.totalInterest);
        const maxExtra = 5;
        const results = calculateEarlyRepayment(P, n, r, emi, maxExtra, totalInterest);
        tbody.innerHTML = results.map(r => `<tr><td>${r.extra}</td><td>${r.newTenure}</td><td>â‚¹${r.newInterest.toLocaleString()}</td><td class='text-success fw-bold'>â‚¹${r.saved.toLocaleString()}</td></tr>`).join('');
    }
}
</script>
</body>
</html> 