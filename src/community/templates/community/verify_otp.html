{% extends "community/base.html" %}

{% block title %}Verify OTP - CreditCare Community{% endblock %}

{% block content %}
<!-- OTP Verification Section -->
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="card shadow-lg border-0">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="bi bi-shield-check text-white fs-2"></i>
                            </div>
                            <h2 class="fw-bold text-primary mb-3">Verify Your Account</h2>
                            <p class="text-muted">Enter the 6-digit code sent to your email/phone</p>
                        </div>
                        
                        <form id="verifyForm" method="POST" action="/community/verify-otp">
                            <input type="hidden" id="otp_id" name="otp_id" value="{{ request.query_params.get('otp_id', '') }}">
                            <input type="hidden" id="email" name="email" value="{{ request.query_params.get('email', '') }}">
                            <input type="hidden" id="phone" name="phone" value="{{ request.query_params.get('phone', '') }}">
                            <input type="hidden" id="email_or_phone" name="email_or_phone" value="{{ request.query_params.get('email_or_phone', '') }}">
                            <input type="hidden" id="username" name="username" value="{{ request.query_params.get('username', '') }}">
                            <input type="hidden" id="full_name" name="full_name" value="{{ request.query_params.get('full_name', '') }}">
                            
                            <div class="mb-4">
                                <label for="otp_code" class="form-label fw-semibold">Verification Code</label>
                                <input type="text" class="form-control text-center fs-3 fw-bold" id="otp_code" name="otp_code" 
                                       maxlength="6" pattern="[0-9]{6}" required 
                                       style="letter-spacing: 0.5em;">
                                <div class="form-text text-center">Enter the 6-digit code</div>
                            </div>
                            
                            <div class="d-grid mb-3">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle me-2"></i>Verify & Continue
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <button type="button" class="btn btn-outline-secondary" onclick="resendOTP()">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Resend Code
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Didn't receive the code?</strong><br>
                                • Check your spam folder<br>
                                • Ensure your email/phone is correct<br>
                                • Wait a few minutes and try resending
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Security Info Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h3 class="h4 fw-bold text-center mb-5">Your Security is Our Priority</h3>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center">
                    <div class="bg-success rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-shield-lock text-white fs-4"></i>
                    </div>
                    <h6 class="fw-bold">Secure Verification</h6>
                    <p class="text-muted small">OTP codes expire in 10 minutes for security</p>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center">
                    <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-person-check text-white fs-4"></i>
                    </div>
                    <h6 class="fw-bold">Verified Account</h6>
                    <p class="text-muted small">Access to verified expert content</p>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="text-center">
                    <div class="bg-warning rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-lock text-white fs-4"></i>
                    </div>
                    <h6 class="fw-bold">Privacy Protected</h6>
                    <p class="text-muted small">Your data is encrypted and secure</p>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Auto-format OTP input
document.getElementById('otp_code').addEventListener('input', function(e) {
    // Remove non-numeric characters
    this.value = this.value.replace(/[^0-9]/g, '');
    
    // Limit to 6 digits
    if (this.value.length > 6) {
        this.value = this.value.slice(0, 6);
    }
});

// Auto-submit when 6 digits are entered
document.getElementById('otp_code').addEventListener('input', function(e) {
    if (this.value.length === 6) {
        // Small delay for better UX
        setTimeout(() => {
            document.getElementById('verifyForm').submit();
        }, 500);
    }
});

// Resend OTP function
function resendOTP() {
    const otpId = document.getElementById('otp_id').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const emailOrPhone = document.getElementById('email_or_phone').value;
    const username = document.getElementById('username').value;
    const fullName = document.getElementById('full_name').value;
    
    if (!otpId) {
        alert('Unable to resend OTP. Please try registering again.');
        return;
    }
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sending...';
    btn.disabled = true;
    
    // Make request to resend OTP
    const formData = new FormData();
    formData.append('otp_id', otpId);
    if (email) formData.append('email', email);
    if (phone) formData.append('phone', phone);
    if (emailOrPhone) formData.append('email_or_phone', emailOrPhone);
    if (username) formData.append('username', username);
    if (fullName) formData.append('full_name', fullName);
    
    fetch('/community/resend-otp', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('New OTP sent successfully!');
        } else {
            alert('Error: ' + (data.detail || data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    })
    .finally(() => {
        // Restore button state
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Form submission
document.getElementById('verifyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const otpCode = document.getElementById('otp_code').value;
    if (otpCode.length !== 6) {
        alert('Please enter a valid 6-digit code.');
        return;
    }
    
    const formData = new FormData(this);
    
    fetch('/community/verify-otp', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Account verified successfully! Welcome to CreditCare!');
            window.location.href = '/community/';
        } else {
            alert('Error: ' + data.detail);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});
</script>
{% endblock %}
