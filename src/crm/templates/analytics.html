{% extends 'base.html' %}

{% block title %}Analytics - Advance Credit CRM{% endblock %}

{% block content %}
<div class="glass-card">
    <!-- Page Header with Filters -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">Analytics Dashboard</h1>
            <p class="page-subtitle">Comprehensive insights into your lead generation performance.</p>
        </div>
        <div class="d-flex gap-2">
            <select id="timeFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="all">All Time</option>
                <option value="this_month">This Month</option>
                <option value="last_month">Last Month</option>
                <option value="last_3_months">Last 3 Months</option>
                <option value="last_6_months">Last 6 Months</option>
                <option value="this_year">This Year</option>
                <option value="last_year">Last Year</option>
            </select>
            <button class="btn btn-primary-modern btn-modern btn-sm" onclick="applyFilters()">
                <i class="bi bi-funnel me-1"></i>Apply
            </button>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon primary">
                    <i class="bi bi-globe"></i>
                </div>
                <h3 class="h4 mb-2" id="websiteLeadsCount">{{ website_leads_count }}</h3>
                <p class="text-muted mb-0">Website Leads</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon secondary">
                    <i class="bi bi-share"></i>
                </div>
                <h3 class="h4 mb-2" id="socialLeadsCount">{{ social_leads_count }}</h3>
                <p class="text-muted mb-0">Social Media Leads</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon success">
                    <i class="bi bi-check-circle"></i>
                </div>
                <h3 class="h4 mb-2" id="convertedLeadsCount">{{ converted_leads_count }}</h3>
                <p class="text-muted mb-0">Converted Leads</p>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-icon warning">
                    <i class="bi bi-graph-up"></i>
                </div>
                <h3 class="h4 mb-2" id="conversionRate">{{ "%.1f"|format(conversion_rate) }}%</h3>
                <p class="text-muted mb-0">Conversion Rate</p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <!-- Lead Status Distribution Chart -->
        <div class="col-lg-6">
            <div class="glass-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Lead Status Distribution</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="changeChartType('pie')">Pie</button>
                        <button class="btn btn-outline-primary" onclick="changeChartType('doughnut')">Doughnut</button>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="leadStatusChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Monthly Lead Trends -->
        <div class="col-lg-6">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Monthly Lead Trends</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyTrendsChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Performance and Team Performance -->
    <div class="row g-4 mb-4">
        <!-- Social Media Platform Performance -->
        <div class="col-lg-8">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Social Media Platform Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="platformChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- Team Performance -->
        <div class="col-lg-4">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Team Performance</h5>
                </div>
                <div class="card-body">
                    <canvas id="teamPerformanceChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Source Comparison and Recent Activity -->
    <div class="row g-4">
        <!-- Lead Source Comparison -->
        <div class="col-lg-6">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Lead Source Comparison</h5>
                </div>
                <div class="card-body">
                    <canvas id="sourceComparisonChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity Timeline -->
        <div class="col-lg-6">
            <div class="glass-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="timeline" id="recentActivity">
                        {% for activity in recent_activities %}
                        <div class="timeline-item">
                            <div class="timeline-marker {{ activity.type }}"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">{{ activity.title }}</h6>
                                <p class="text-muted mb-0">{{ activity.description }}</p>
                                <small class="text-muted">{{ activity.time }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-marker.website {
    background-color: #007bff;
}

.timeline-marker.social {
    background-color: #6c757d;
}

.timeline-marker.conversion {
    background-color: #28a745;
}

.timeline-marker.assignment {
    background-color: #ffc107;
}

.timeline-content {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #007bff;
}

.stats-card {
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-5px);
}
</style>

<script>
// Chart instances
let leadStatusChart, monthlyTrendsChart, platformChart, teamPerformanceChart, sourceComparisonChart;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Lead Status Distribution Chart
    const leadStatusCtx = document.getElementById('leadStatusChart').getContext('2d');
    leadStatusChart = new Chart(leadStatusCtx, {
        type: 'pie',
        data: {
            labels: ['Active', 'Converted', 'Lost', 'Pending'],
            datasets: [{
                data: [{{ active_leads_count }}, {{ converted_leads_count }}, {{ lost_leads_count }}, {{ pending_leads_count }}],
                backgroundColor: ['#007bff', '#28a745', '#dc3545', '#ffc107'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Monthly Trends Chart
    const monthlyCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
    monthlyTrendsChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels | tojson }},
            datasets: [{
                label: 'Website Leads',
                data: {{ website_monthly_data | tojson }},
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }, {
                label: 'Social Leads',
                data: {{ social_monthly_data | tojson }},
                borderColor: '#6c757d',
                backgroundColor: 'rgba(108, 117, 125, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Platform Performance Chart
    const platformCtx = document.getElementById('platformChart').getContext('2d');
    platformChart = new Chart(platformCtx, {
        type: 'bar',
        data: {
            labels: {{ platform_labels | tojson }},
            datasets: [{
                label: 'Leads',
                data: {{ platform_data | tojson }},
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Team Performance Chart
    const teamCtx = document.getElementById('teamPerformanceChart').getContext('2d');
    teamPerformanceChart = new Chart(teamCtx, {
        type: 'doughnut',
        data: {
            labels: {{ team_labels | tojson }},
            datasets: [{
                data: {{ team_data | tojson }},
                backgroundColor: [
                    '#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        }
    });

    // Source Comparison Chart
    const sourceCtx = document.getElementById('sourceComparisonChart').getContext('2d');
    sourceComparisonChart = new Chart(sourceCtx, {
        type: 'bar',
        data: {
            labels: ['Website', 'Social Media'],
            datasets: [{
                label: 'Total Leads',
                data: [{{ website_leads_count }}, {{ social_leads_count }}],
                backgroundColor: ['#007bff', '#6c757d']
            }, {
                label: 'Converted',
                data: [{{ website_converted_count }}, {{ social_converted_count }}],
                backgroundColor: ['#28a745', '#20c997']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function changeChartType(type) {
    if (leadStatusChart) {
        leadStatusChart.destroy();
        const ctx = document.getElementById('leadStatusChart').getContext('2d');
        leadStatusChart = new Chart(ctx, {
            type: type,
            data: {
                labels: ['Active', 'Converted', 'Lost', 'Pending'],
                datasets: [{
                    data: [{{ active_leads_count }}, {{ converted_leads_count }}, {{ lost_leads_count }}, {{ pending_leads_count }}],
                    backgroundColor: ['#007bff', '#28a745', '#dc3545', '#ffc107'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

function applyFilters() {
    const timeFilter = document.getElementById('timeFilter').value;
    
    // Show loading state
    document.body.style.cursor = 'wait';
    
    // Make AJAX request to get filtered data
    fetch(`/crm/analytics/data?filter=${timeFilter}`)
        .then(response => response.json())
        .then(data => {
            updateCharts(data);
            updateMetrics(data);
            document.body.style.cursor = 'default';
        })
        .catch(error => {
            console.error('Error fetching analytics data:', error);
            document.body.style.cursor = 'default';
        });
}

function updateCharts(data) {
    // Update Lead Status Chart
    leadStatusChart.data.datasets[0].data = [
        data.active_leads_count,
        data.converted_leads_count,
        data.lost_leads_count,
        data.pending_leads_count
    ];
    leadStatusChart.update();

    // Update Monthly Trends Chart
    monthlyTrendsChart.data.labels = data.monthly_labels;
    monthlyTrendsChart.data.datasets[0].data = data.website_monthly_data;
    monthlyTrendsChart.data.datasets[1].data = data.social_monthly_data;
    monthlyTrendsChart.update();

    // Update Platform Chart
    platformChart.data.labels = data.platform_labels;
    platformChart.data.datasets[0].data = data.platform_data;
    platformChart.update();

    // Update Team Performance Chart
    teamPerformanceChart.data.labels = data.team_labels;
    teamPerformanceChart.data.datasets[0].data = data.team_data;
    teamPerformanceChart.update();

    // Update Source Comparison Chart
    sourceComparisonChart.data.datasets[0].data = [data.website_leads_count, data.social_leads_count];
    sourceComparisonChart.data.datasets[1].data = [data.website_converted_count, data.social_converted_count];
    sourceComparisonChart.update();
}

function updateMetrics(data) {
    document.getElementById('websiteLeadsCount').textContent = data.website_leads_count;
    document.getElementById('socialLeadsCount').textContent = data.social_leads_count;
    document.getElementById('convertedLeadsCount').textContent = data.converted_leads_count;
    document.getElementById('conversionRate').textContent = data.conversion_rate + '%';
}
</script>
{% endblock %} 