{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Lead Information -->
        <div class="col-lg-8">
            <div class="glass-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="text-primary mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Lead Details
                    </h3>
                    <div>
                        <a href="{% if lead_type == 'website' %}/crm/website-leads{% else %}/crm/social-leads{% endif %}" 
                           class="btn btn-outline-secondary-modern btn-modern">
                            <i class="bi bi-arrow-left me-2"></i>Back to Leads
                        </a>
                    </div>
                </div>

                <!-- Lead Basic Info -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="info-group">
                            <label class="info-label">Name</label>
                            <div class="info-value">{{ lead.name }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-group">
                            <label class="info-label">Contact</label>
                            <div class="info-value">{{ lead.contact }}</div>
                        </div>
                    </div>
                    {% if lead.email %}
                    <div class="col-md-6">
                        <div class="info-group">
                            <label class="info-label">Email</label>
                            <div class="info-value">{{ lead.email }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if lead_type == 'social' %}
                    <div class="col-md-6">
                        <div class="info-group">
                            <label class="info-label">City</label>
                            <div class="info-value">{{ lead.city or 'Not specified' }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-group">
                            <label class="info-label">Platform</label>
                            <div class="info-value">{{ lead.platform_name }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-group">
                            <label class="info-label">Loan Amount</label>
                            <div class="info-value">â‚¹{{ "{:,.2f}".format(lead.loan_amount) if lead.loan_amount else 'Not specified' }}</div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-12">
                        <div class="info-group">
                            <label class="info-label">Created</label>
                            <div class="info-value">{{ lead.created_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                        </div>
                    </div>
                    {% if lead.message %}
                    <div class="col-12">
                        <div class="info-group">
                            <label class="info-label">Message/Query</label>
                            <div class="info-value">{{ lead.message }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Assignment Information -->
                {% if assignment %}
                <div class="glass-card mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="bi bi-person-check me-2"></i>Assignment Details
                    </h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="info-label">Assigned To</label>
                                <div class="info-value">
                                    {{ assignment.employee.user.name }} ({{ assignment.employee.employee_code }})
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="info-label">Assigned By</label>
                                <div class="info-value">
                                    {{ assignment.assigned_by_employee.user.name if assignment.assigned_by_employee else 'System' }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="info-label">Assigned Date</label>
                                <div class="info-value">{{ assignment.assigned_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-group">
                                <label class="info-label">Last Updated</label>
                                <div class="info-value">{{ assignment.last_updated.strftime('%B %d, %Y at %I:%M %p') }}</div>
                            </div>
                        </div>
                        {% if assignment.notes %}
                        <div class="col-12">
                            <div class="info-group">
                                <label class="info-label">Assignment Notes</label>
                                <div class="info-value">{{ assignment.notes }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="glass-card mb-4">
                    <div class="text-center py-4">
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                        <h5 class="text-warning mt-3">Lead Not Assigned</h5>
                        <p class="text-muted">This lead has not been assigned to any employee yet.</p>
                        {% if user_role in ['admin', 'manager'] %}
                        <button class="btn btn-primary-modern btn-modern" onclick="showAssignModal()">
                            <i class="bi bi-person-plus me-2"></i>Assign Lead
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Status Management & Comments -->
        <div class="col-lg-4">
            {% if assignment %}
            <!-- Status Management -->
            <div class="glass-card mb-4">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-flag me-2"></i>Status Management
                </h5>
                
                <div class="mb-3">
                    <label class="form-label">Current Status</label>
                    <div class="status-badge status-{{ assignment.status }}">
                        {{ status_display.get(assignment.status, assignment.status) }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Doable Status</label>
                    <div class="d-flex align-items-center gap-2">
                        <div class="doable-badge {{ 'doable' if assignment.is_doable else 'not-doable' }}">
                            <i class="bi {{ 'bi-check-circle' if assignment.is_doable else 'bi-x-circle' }}"></i>
                            {{ 'Doable' if assignment.is_doable else 'Not Doable' }}
                        </div>
                        {% if can_update_status %}
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDoable()">
                            <i class="bi bi-arrow-repeat"></i> Toggle
                        </button>
                        {% endif %}
                    </div>
                </div>

                {% if can_update_status %}
                <form id="statusUpdateForm">
                    <div class="mb-3">
                        <label class="form-label">Update Status</label>
                        <!-- Debug info -->
                        <div class="text-muted small mb-2">
                            Debug: Current status: {{ assignment.status }}, Next statuses: {{ next_statuses }}, Can update: {{ can_update_status }}
                        </div>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Select new status...</option>
                            {% for status in next_statuses %}
                            <option value="{{ status }}">{{ status_display.get(status, status) }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Add Comment (Optional)</label>
                        <textarea class="form-control" id="statusComment" rows="3" 
                                  placeholder="Add a comment about this status change..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary-modern btn-modern w-100">
                        <i class="bi bi-check-circle me-2"></i>Update Status
                    </button>
                </form>
                {% endif %}
            </div>

            <!-- Comments Section -->
            <div class="glass-card">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-chat-dots me-2"></i>Comments
                </h5>
                
                <!-- Add Comment Form -->
                <form id="commentForm" class="mb-4">
                    <div class="mb-3">
                        <textarea class="form-control" id="newComment" rows="3" 
                                  placeholder="Add a comment..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-outline-primary-modern btn-modern w-100">
                        <i class="bi bi-plus-circle me-2"></i>Add Comment
                    </button>
                </form>

                <!-- Comments List -->
                <div id="commentsList">
                    {% for comment in comments %}
                    <div class="comment-item mb-3">
                        <div class="comment-header">
                            <strong>{{ comment.employee_name }}</strong>
                            <small class="text-muted">{{ comment.created_at }}</small>
                        </div>
                        <div class="comment-body">
                            {{ comment.comment }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Assign Lead Modal -->
{% if user_role in ['admin', 'manager'] %}
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Lead</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Employee</label>
                        <select class="form-select" id="assignEmployee" required>
                            <option value="">Choose employee...</option>
                            {% for emp in available_employees %}
                            <option value="{{ emp.employee_id }}">{{ emp.user.name }} ({{ emp.employee_code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assignment Notes (Optional)</label>
                        <textarea class="form-control" id="assignNotes" rows="3" 
                                  placeholder="Add notes for the assignment..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary-modern btn-modern">Assign Lead</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.info-group {
    margin-bottom: 1rem;
}

.info-label {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.info-value {
    color: #212529;
    font-size: 1rem;
}

.status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.875rem;
}

.status-assigned { background-color: #e3f2fd; color: #1976d2; }
.status-pd { background-color: #fff3e0; color: #f57c00; }
.status-login { background-color: #e8f5e8; color: #388e3c; }
.status-login_query { background-color: #f3e5f5; color: #7b1fa2; }
.status-underwriter { background-color: #fff8e1; color: #fbc02d; }
.status-approved { background-color: #e8f5e8; color: #2e7d32; }
.status-rejected { background-color: #ffebee; color: #d32f2f; }
.status-closed { background-color: #f5f5f5; color: #6c757d; }
.status-disbursed { background-color: #d4edda; color: #155724; }

.doable-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    font-size: 0.875rem;
}

.doable-badge.doable {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.doable-badge.not-doable {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
}

.comment-item {
    border-left: 3px solid #e9ecef;
    padding-left: 1rem;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.comment-body {
    color: #495057;
    line-height: 1.5;
}
</style>

<script>
const assignmentId = {{ assignment.assignment_id if assignment else 'null' }};
const leadId = {{ lead.lead_id }};
const leadType = '{{ lead_type }}';

// Status Update Form
if (document.getElementById('statusUpdateForm')) {
    document.getElementById('statusUpdateForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const newStatus = document.getElementById('newStatus').value;
        const comment = document.getElementById('statusComment').value;
        
        if (!newStatus) {
            alert('Please select a new status');
            return;
        }
        
        const formData = new FormData();
        formData.append('new_status', newStatus);
        if (comment) formData.append('comment', comment);
        
        try {
            const response = await fetch(`/crm/leads/${assignmentId}/update-status`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                // If status is closed, redirect to closed leads page
                if (newStatus === 'closed') {
                    window.location.href = '/crm/close-leads';
                } else {
                    location.reload();
                }
            } else {
                alert('Error: ' + result.detail);
            }
        } catch (error) {
            alert('Error updating status: ' + error.message);
        }
    });
}

// Comment Form
if (document.getElementById('commentForm')) {
    document.getElementById('commentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const comment = document.getElementById('newComment').value;
        
        if (!comment.trim()) {
            alert('Please enter a comment');
            return;
        }
        
        const formData = new FormData();
        formData.append('comment', comment);
        
        try {
            const response = await fetch(`/crm/leads/${assignmentId}/add-comment`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('newComment').value = '';
                addCommentToUI(result.comment);
            } else {
                alert('Error: ' + result.detail);
            }
        } catch (error) {
            alert('Error adding comment: ' + error.message);
        }
    });
}

function addCommentToUI(comment) {
    const commentsList = document.getElementById('commentsList');
    const commentHtml = `
        <div class="comment-item mb-3">
            <div class="comment-header">
                <strong>${comment.employee_name}</strong>
                <small class="text-muted">${comment.created_at}</small>
            </div>
            <div class="comment-body">
                ${comment.comment}
            </div>
        </div>
    `;
    commentsList.insertAdjacentHTML('afterbegin', commentHtml);
}

// Assign Lead Modal
function showAssignModal() {
    new bootstrap.Modal(document.getElementById('assignModal')).show();
}

if (document.getElementById('assignForm')) {
    document.getElementById('assignForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const employeeId = document.getElementById('assignEmployee').value;
        const notes = document.getElementById('assignNotes').value;
        
        if (!employeeId) {
            alert('Please select an employee');
            return;
        }
        
        const formData = new FormData();
        formData.append('employee_id', employeeId);
        if (notes) formData.append('notes', notes);
        
        try {
            const response = await fetch(`/crm/unified-leads/${leadId}/assign`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.detail);
            }
        } catch (error) {
            alert('Error assigning lead: ' + error.message);
        }
    });
}

// Toggle Doable Flag
async function toggleDoable() {
    if (!confirm('Are you sure you want to toggle the doable status? This will automatically close the lead if marked as not doable.')) {
        return;
    }
    
    try {
        const response = await fetch(`/crm/leads/${assignmentId}/toggle-doable`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            // If lead is marked as not doable, redirect to closed leads page
            window.location.href = '/crm/close-leads';
        } else {
            alert('Error: ' + result.detail);
        }
    } catch (error) {
        alert('Error toggling doable flag: ' + error.message);
    }
}
</script>
{% endblock %}




