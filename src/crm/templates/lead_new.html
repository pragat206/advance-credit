{% extends 'base.html' %}

{% block title %}
    {% if lead_type == "website" %}
        Add Website Lead - Advance Credit CRM
    {% else %}
        Add Social Media Lead - Advance Credit CRM
    {% endif %}
{% endblock %}

{% block content %}
<div class="glass-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">
                {% if lead_type == "website" %}
                    <i class="bi bi-globe me-2"></i>Add Website Lead
                {% else %}
                    <i class="bi bi-share me-2"></i>Add Social Media Lead
                {% endif %}
            </h1>
            <p class="page-subtitle">
                {% if lead_type == "website" %}
                    Create a new website lead and assign it to an employee
                {% else %}
                    Create a new social media lead and assign it to an employee
                {% endif %}
            </p>
        </div>
        <a href="{% if lead_type == 'website' %}/crm/website-leads{% else %}/crm/social-leads{% endif %}" class="btn btn-secondary-modern btn-modern">
            <i class="bi bi-arrow-left me-2"></i>Back to Leads
        </a>
    </div>

    {% if error %}
    <div class="alert alert-danger alert-modern" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
    </div>
    {% endif %}

    <form method="POST" class="needs-validation" novalidate>
        <div class="row g-4">
            <!-- Basic Information -->
            <div class="col-lg-8">
                <div class="glass-card">
                    <h5 class="mb-3"><i class="bi bi-person me-2"></i>Lead Information</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Full Name *</label>
                            <input type="text" class="form-control form-control-modern" id="name" name="name" required>
                            <div class="invalid-feedback">Please provide a name.</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="contact" class="form-label">Contact Number *</label>
                            <input type="tel" class="form-control form-control-modern" id="contact" name="contact" required>
                            <div class="invalid-feedback">Please provide a contact number.</div>
                        </div>

                        {% if lead_type == "website" %}
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control form-control-modern" id="email" name="email">
                            <div class="invalid-feedback">Please provide a valid email address.</div>
                        </div>
                        
                        <div class="col-12">
                            <label for="message" class="form-label">Message/Query</label>
                            <textarea class="form-control form-control-modern" id="message" name="message" rows="4" placeholder="Enter the lead's message or query..."></textarea>
                        </div>
                        {% else %}
                        <div class="col-md-6">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control form-control-modern" id="city" name="city" placeholder="Enter city name">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="platform_name" class="form-label">Platform *</label>
                            <select class="form-select form-select-modern" id="platform_name" name="platform_name" required>
                                <option value="">Select Platform</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Facebook">Facebook</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Twitter">Twitter</option>
                                <option value="YouTube">YouTube</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="invalid-feedback">Please select a platform.</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="any_ongoing_loan" class="form-label">Any Ongoing Loan?</label>
                            <select class="form-select form-select-modern" id="any_ongoing_loan" name="any_ongoing_loan">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="loan_amount" class="form-label">Loan Amount (â‚¹)</label>
                            <input type="number" class="form-control form-control-modern" id="loan_amount" name="loan_amount" placeholder="Enter loan amount" min="0" step="1000">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Assignment Information -->
            <div class="col-lg-4">
                <div class="glass-card">
                    <h5 class="mb-3"><i class="bi bi-person-check me-2"></i>Assignment</h5>
                    
                    <div class="mb-3">
                        <label for="assigned_employee_id" class="form-label">Assign to Employee</label>
                        <select class="form-select form-select-modern" id="assigned_employee_id" name="assigned_employee_id">
                            <option value="">Select Employee (Optional)</option>
                            {% for employee in employees %}
                            <option value="{{ employee.employee_id }}">
                                {{ employee.employee_code }} - {{ employee.user.name }}
                                {% if employee.designation %} ({{ employee.designation }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Leave empty to create unassigned lead. You can assign it later.
                        </small>
                    </div>

                    <div class="alert alert-info alert-modern" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Note:</strong> Only Admin and Manager roles can create leads. 
                        {% if request.session.user_role == "admin" %}
                            You can assign to any employee.
                        {% else %}
                            You can only assign to your team members.
                        {% endif %}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="glass-card">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary-modern btn-modern">
                            <i class="bi bi-plus-circle me-2"></i>
                            {% if lead_type == "website" %}
                                Create Website Lead
                            {% else %}
                                Create Social Media Lead
                            {% endif %}
                        </button>
                        
                        <a href="{% if lead_type == 'website' %}/crm/website-leads{% else %}/crm/social-leads{% endif %}" class="btn btn-outline-secondary-modern btn-modern">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Auto-format phone number
document.getElementById('contact').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 10) {
        value = value.substring(0, 10);
    }
    e.target.value = value;
});

// Auto-format loan amount
document.getElementById('loan_amount').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    e.target.value = value;
});
</script>
{% endblock %} 