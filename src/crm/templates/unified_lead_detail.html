{% extends "base.html" %}

{% block title %}Lead Details - CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title">
                <i class="bi bi-person me-2"></i>Lead Details
            </h1>
            <p class="page-subtitle">Lead #{{ lead.lead_id }} - {{ lead.name }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/crm/unified-leads" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Leads
            </a>
            {% if assignment and assignment.status == 'approved' %}
            <div class="alert alert-success mb-0 d-flex align-items-center">
                <i class="bi bi-check-circle me-2"></i>
                <strong>Case Approved!</strong> Ready for disbursement.
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        <!-- Lead Information -->
        <div class="col-lg-8">
            <!-- Lead Details Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Lead Information
                    </h5>
                    {% if can_update_lead %}
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editLeadModal">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <!-- Basic Information Section -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-circle me-2"></i>Basic Information
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Name</label>
                            <p class="mb-0">{{ lead.name }}</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Contact</label>
                            <p class="mb-0">
                                <a href="tel:{{ lead.contact }}" class="text-decoration-none">
                                    <i class="bi bi-telephone me-1"></i>{{ lead.contact }}
                                </a>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email</label>
                            <p class="mb-0">
                                {% if lead.email %}
                                    <a href="mailto:{{ lead.email }}" class="text-decoration-none">
                                        <i class="bi bi-envelope me-1"></i>{{ lead.email }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">City</label>
                            <p class="mb-0">
                                {% if lead.city %}
                                    <i class="bi bi-geo-alt me-1"></i>{{ lead.city }}
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Date of Birth</label>
                            <p class="mb-0">
                                {% if lead.additional_data and lead.additional_data.date_of_birth %}
                                    <i class="bi bi-calendar me-1"></i>{{ lead.additional_data.date_of_birth }}
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Optional Fields Section (Collapsible) -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#optionalFields" aria-expanded="false" aria-controls="optionalFields">
                                <h6 class="text-info mb-3">
                                    <i class="bi bi-chevron-right me-2" id="optionalFieldsIcon"></i>Additional Details
                                    <small class="text-muted">(Click to expand)</small>
                            </h6>
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapse" id="optionalFields">
                        <div class="row g-3 mb-4">
                        <div class="col-md-6">
                                <label class="form-label fw-bold">Monthly Income</label>
                            <p class="mb-0">
                                    {% if lead.additional_data and lead.additional_data.monthly_income %}
                                        <i class="bi bi-currency-rupee me-1"></i>₹{{ "{:,.0f}".format(lead.additional_data.monthly_income) }}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                                <label class="form-label fw-bold">Credit Score</label>
                            <p class="mb-0">
                                    {% if lead.additional_data and lead.additional_data.credit_score %}
                                        <i class="bi bi-graph-up me-1"></i>{{ lead.additional_data.credit_score }}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                                <label class="form-label fw-bold">Employment Type</label>
                            <p class="mb-0">
                                    {% if lead.additional_data and lead.additional_data.employment_type %}
                                        <span class="badge bg-primary">{{ lead.additional_data.employment_type|title }}</span>
                                {% else %}
                                        <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                                <label class="form-label fw-bold">Preferred Contact Time</label>
                            <p class="mb-0">
                                    {% if lead.additional_data and lead.additional_data.preferred_contact_time %}
                                        <i class="bi bi-clock me-1"></i>{{ lead.additional_data.preferred_contact_time|title }}
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Source Details</label>
                                <p class="mb-0">
                                    {% if lead.additional_data and lead.additional_data.source_details %}
                                        <i class="bi bi-tag me-1"></i>{{ lead.additional_data.source_details }}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                            </div>
                        </div>
                    </div>

                    <!-- Loan Information Section -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <h6 class="text-success mb-3">
                                <i class="bi bi-cash-coin me-2"></i>Loan Information
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Loan Amount</label>
                            <p class="mb-0">
                                {% if lead.loan_amount %}
                                    <i class="bi bi-currency-rupee me-1"></i>₹{{ "{:,.0f}".format(lead.loan_amount) }}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Loan Type</label>
                            <p class="mb-0">
                                {% if lead.loan_type %}
                                    <span class="badge bg-success">{{ lead.loan_type|title }}</span>
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Occupation</label>
                            <p class="mb-0">
                                {% if lead.occupation %}
                                    <i class="bi bi-briefcase me-1"></i>{{ lead.occupation }}
                                {% else %}
                                    <span class="text-muted">Not provided</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ongoing Loans</label>
                            <p class="mb-0">
                                {% if lead.any_ongoing_loan %}
                                    {% if lead.any_ongoing_loan == 'yes' %}
                                        <span class="badge bg-warning">Yes</span>
                                    {% else %}
                                        <span class="badge bg-success">No</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="row g-3">
                        <div class="col-12">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>Additional Information
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Source</label>
                            <span class="badge bg-info">{{ lead.source|title }}</span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Created</label>
                            <p class="mb-0">
                                <i class="bi bi-calendar me-1"></i>{{ lead.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                        </div>
                        {% if lead.message %}
                        <div class="col-12">
                            <label class="form-label fw-bold">Message</label>
                            <div class="bg-light p-3 rounded">
                                <i class="bi bi-chat-quote me-1"></i>{{ lead.message }}
                            </div>
                        </div>
                        {% endif %}
                        {% if lead.other_details %}
                        <div class="col-12">
                            <label class="form-label fw-bold">Other Details</label>
                            <div class="bg-light p-3 rounded">
                                <i class="bi bi-file-text me-1"></i>{{ lead.other_details }}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Quick Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editLeadModal">
                                    <i class="bi bi-pencil me-1"></i>Edit All Details
                                </button>
                                {% if lead.email %}
                                <a href="mailto:{{ lead.email }}" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-envelope me-1"></i>Send Email
                                </a>
                                {% endif %}
                                <a href="tel:{{ lead.contact }}" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-telephone me-1"></i>Call
                                </a>
                                <a href="https://wa.me/91{{ lead.contact }}" target="_blank" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-whatsapp me-1"></i>WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignment Information -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-check me-2"></i>Assignment Details
                    </h5>
                    <div class="d-flex gap-2">
                        <!-- Priority Toggle Button -->
                        <button class="btn btn-sm {% if lead.priority == 'doable' %}btn-outline-success{% else %}btn-outline-secondary{% endif %}" id="togglePriorityBtn" onclick="togglePriority()">
                            <i class="bi bi-flag me-1"></i>
                            <span id="priorityText">
                                {% if lead.priority == 'doable' %}Doable{% else %}Not Doable{% endif %}
                            </span>
                        </button>
                        
                        {% if not assignment %}
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#assignLeadModal">
                                <i class="bi bi-person-plus me-1"></i>Assign Lead
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#reassignLeadModal">
                                <i class="bi bi-arrow-repeat me-1"></i>Reassign
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if assignment %}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Assigned To</label>
                                <p class="mb-0">{{ assignment.employee.user.name }} ({{ assignment.employee.employee_code }})</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Assigned Date</label>
                                <p class="mb-0">{{ assignment.assigned_at.strftime('%d/%m/%Y %H:%M') }}</p>
                            </div>
                            {% if assignment.pd_loan_amount %}
                            <div class="col-md-6">
                                <label class="form-label fw-bold">PD Loan Amount</label>
                                <p class="mb-0 text-success">₹{{ "{:,.0f}".format(assignment.pd_loan_amount) }}</p>
                            </div>
                            {% endif %}
                            {% if assignment.approved_loan_amount %}
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Approved Loan Amount</label>
                                <p class="mb-0 text-success">₹{{ "{:,.0f}".format(assignment.approved_loan_amount) }}</p>
                            </div>
                            {% endif %}
                            {% if assignment.notes %}
                            <div class="col-12">
                                <label class="form-label fw-bold">Assignment Notes</label>
                                <p class="mb-0">{{ assignment.notes }}</p>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-person-x text-muted fs-1 mb-3"></i>
                            <h6 class="text-muted">Lead Not Assigned</h6>
                            <p class="text-muted mb-0">This lead has not been assigned to any employee yet.</p>
                            <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#assignLeadModal">
                                <i class="bi bi-person-plus me-2"></i>Assign Lead
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Comments Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots me-2"></i>Comments & Notes
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Add Comment Form -->
                    <form id="commentForm" class="mb-4">
                        <div class="row g-2">
                            <div class="col">
                                <input type="text" class="form-control" id="commentText" placeholder="Add a comment..." required>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Comments List -->
                    <div id="commentsList">
                        {% for comment in comments %}
                        <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="{{ comment.comment_id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <strong class="me-2">{{ comment.employee.user.name }}</strong>
                                        <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                    </div>
                                    <p class="mb-0">{{ comment.comment }}</p>
                                </div>
                                {% if can_delete_comment(comment.employee_id) %}
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteComment({{ comment.comment_id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Activity Log Section -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Activity Log
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div id="activityList" class="jira-activity-log">
                        {% for activity in timeline %}
                        <div class="activity-item" data-activity-type="{{ activity.activity_type }}">
                            <div class="activity-timeline">
                                <div class="activity-avatar">
                                    {% if activity.employee_name and activity.employee_name != 'System' %}
                                        <div class="avatar-circle">
                                            {{ activity.employee_name.split()[0][0] if activity.employee_name.split() else 'U' }}
                                        </div>
                                    {% else %}
                                        <div class="avatar-circle system">
                                            <i class="bi bi-gear"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="activity-content">
                                    <div class="activity-header">
                                        <div class="activity-meta">
                                            <span class="activity-user">{{ activity.employee_name if activity.employee_name else 'System' }}</span>
                                            <span class="activity-action">
                                    {% if activity.activity_type == 'created' %}
                                                    created this lead
                                    {% elif activity.activity_type == 'status_changed' %}
                                                    changed status
                                    {% elif activity.activity_type == 'comment_added' %}
                                                    added a comment
                                    {% elif activity.activity_type == 'comment_deleted' %}
                                                    deleted a comment
                                    {% elif activity.activity_type == 'lead_updated' %}
                                                    updated lead information
                                    {% elif activity.activity_type == 'assigned' %}
                                                    assigned this lead
                                                {% elif activity.activity_type == 'pd_amount_updated' %}
                                                    updated PD amount
                                                {% elif activity.activity_type == 'approved_amount_updated' %}
                                                    updated approved amount
                                                {% elif activity.activity_type == 'disbursement_created' %}
                                                    created disbursement
                                                {% elif activity.activity_type == 'lead_closed' %}
                                                    closed this lead
                                    {% else %}
                                                    performed an action
                                    {% endif %}
                                            </span>
                                </div>
                                        <div class="activity-time">
                                            <time datetime="{{ activity.created_at.isoformat() if activity.created_at else '' }}">
                                                {{ activity.created_at.strftime('%d %b %Y at %H:%M') if activity.created_at else '' }}
                                            </time>
                                    </div>
                                    </div>
                                    
                                    <div class="activity-body">
                                        <div class="activity-description">
                                            {{ activity.description }}
                                        </div>
                                        
                                    {% if activity.activity_data and activity.activity_data|length > 0 %}
                                        <div class="activity-details">
                                        {% for key, value in activity.activity_data.items() %}
                                                {% if key not in ['comment', 'close_type'] and value %}
                                                    <div class="activity-field">
                                                        <span class="field-label">{{ key.replace('_', ' ').title() }}:</span>
                                                        <span class="field-value">{{ value }}</span>
                                                    </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                        
                                        {% if activity.activity_data and activity.activity_data.get('comment') %}
                                        <div class="activity-comment">
                                            <div class="comment-content">
                                                {{ activity.activity_data.comment }}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Tree and Actions -->
        <div class="col-lg-4">
            <!-- Progress Tree -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3 me-2"></i>Progress Tree
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshTree()" title="Refresh Tree">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="workflow-progress" data-lead-id="{{ lead.lead_id }}" data-status="{{ assignment.status if assignment else lead.status }}" data-cache-buster="{{ cache_buster }}">
                        {% if workflow_progress %}
                            <div class="workflow-tree">
                                <!-- Main vertical flow -->
                                <div class="main-flow">
                                    {% for step in workflow_progress %}
                                        {% if step.status in ['new', 'assigned', 'pd', 'documentation', 'login', 'underwriter', 'closed'] %}
                                            <div class="tree-step {{ step.status_class }}" data-status="{{ step.status }}">
                                                <div class="step-icon">
                                                    <i class="bi {{ step.icon }}"></i>
                                                </div>
                                                <div class="step-content">
                                                    <div class="step-label">{{ step.label }}</div>
                                                    <div class="step-status">
                                                        {% if step.status_class == 'completed' %}✓ Completed{% elif step.status_class == 'current' %}● Current{% else %}○ Pending{% endif %}
                                                    </div>
                                                </div>
                                                {% if step.status_class == 'current' %}
                                                <div class="current-indicator"></div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Connector line -->
                                            {% if not loop.last %}
                                            <div class="step-connector {% if step.completed %}completed{% endif %}"></div>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                
                                <!-- Decision branches after underwriter -->
                                {% if assignment and assignment.status in ['underwriter', 'approved', 'rejected', 'disbursed'] %}
                                <div class="decision-flow">
                                    <div class="decision-split">
                                        <div class="decision-line"></div>
                                        <div class="decision-label">Underwriter Decision</div>
                                    </div>
                                    
                                    <div class="decision-branches">
                                        <!-- Approved Path -->
                                        <div class="branch approved-branch">
                                            <div class="branch-label">Approved Path</div>
                                            <div class="tree-step {{ 'completed' if assignment.status in ['approved', 'disbursed'] else 'pending' }}" data-status="approved">
                                                <div class="step-icon">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </div>
                                                <div class="step-content">
                                                    <div class="step-label">Approved</div>
                                                    <div class="step-status">
                                                        {% if assignment.status in ['approved', 'disbursed'] %}✓ Completed{% else %}○ Pending{% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% if assignment.status in ['approved', 'disbursed'] %}
                                            <div class="step-connector completed"></div>
                                            <div class="tree-step {{ 'completed' if assignment.status == 'disbursed' else 'pending' }}" data-status="disbursed">
                                                <div class="step-icon">
                                                    <i class="bi bi-cash-coin"></i>
                                                </div>
                                                <div class="step-content">
                                                    <div class="step-label">Disbursed</div>
                                                    <div class="step-status">
                                                        {% if assignment.status == 'disbursed' %}✓ Completed{% else %}○ Pending{% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Rejected Path -->
                                        <div class="branch rejected-branch">
                                            <div class="branch-label">Rejected Path</div>
                                            <div class="tree-step {{ 'completed' if assignment.status == 'rejected' else 'pending' }}" data-status="rejected">
                                                <div class="step-icon">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                </div>
                                                <div class="step-content">
                                                    <div class="step-label">Rejected</div>
                                                    <div class="step-status">
                                                        {% if assignment.status == 'rejected' %}✓ Completed{% else %}○ Pending{% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                                </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                                <p>Workflow progress not available</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Status Management -->
            {% if assignment %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>Status Management
                    </h5>
                </div>
                <div class="card-body">
                    <form id="statusForm">
                        <div class="mb-3">
                            <label class="form-label">Current Status</label>
                            <div class="alert alert-info">
                                <strong>{{ assignment.status|title }}</strong>
                                <br><small>{{ status_descriptions.get(assignment.status, '') }}</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Move to Stage</label>
                            <select class="form-select" id="newStatus" name="new_status" required>
                                <option value="">Select new stage...</option>
                                {% for status in next_statuses %}
                                <option value="{{ status }}">{{ status|title }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Available stages: {{ next_statuses|join(', ') }}</small>
                        </div>
                        
                        <!-- Close Type Selection (shown when "closed" is selected) -->
                        <div class="mb-3" id="closeTypeSection" style="display: none;">
                            <label class="form-label">Closure Reason</label>
                            <select class="form-select" id="closeType" name="close_type">
                                <option value="">Select closure reason...</option>
                                <option value="approved">Approved & Closed</option>
                                <option value="rejected">Rejected & Closed</option>
                                <option value="not_doable">Not Doable</option>
                                <option value="cancelled">Cancelled by Customer</option>
                                <option value="duplicate">Duplicate Lead</option>
                            </select>
                            <small class="text-muted">Specify why this lead is being closed</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Status Update Comment (Optional)</label>
                            <textarea class="form-control" id="statusComment" name="comment" rows="3" placeholder="Add a comment about this status change..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-arrow-up-circle me-2"></i>Update Status
                        </button>
                    </form>
                    
                    <!-- Close Lead Button -->
                    {% if assignment and assignment.status not in ['closed'] %}
                    <hr class="my-3">
                    <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#closeLeadModal">
                        <i class="bi bi-archive me-2"></i>Close Lead
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Other Details Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text me-2"></i>Other Details
                    </h5>
                    {% if assignment %}
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOtherDetailsModal">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if lead.other_details %}
                        <p class="mb-0">{{ lead.other_details }}</p>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-file-text text-muted fs-1 mb-2"></i>
                            <p class="text-muted mb-0">No additional details added yet.</p>
                            {% if assignment %}
                            <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#editOtherDetailsModal">
                                <i class="bi bi-plus me-1"></i>Add Details
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Loan Amount Tracking -->
            {% if assignment %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-cash me-2"></i>Loan Amount Tracking
                    </h5>
                </div>
                <div class="card-body">
                    {% if assignment.status == 'assigned' %}
                    <!-- Set PD Loan Amount -->
                    <form id="pdAmountForm" class="mb-3">
                        <label class="form-label">Set PD Loan Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="pdAmount" name="pd_amount" placeholder="Enter amount" required>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check me-1"></i>Set
                            </button>
                        </div>
                    </form>
                    {% endif %}
                    
                    {% if assignment.status == 'approved' %}
                    <!-- Create Disbursement -->
                    <form id="disbursementForm">
                        <label class="form-label">Create Disbursement</label>
                        <div class="mb-2">
                            <input type="number" class="form-control" id="disbursementAmount" name="amount" placeholder="Disbursement amount" required>
                        </div>
                        <div class="mb-2">
                            <select class="form-select" id="disbursementType" name="disbursement_type" required>
                                <option value="">Select type</option>
                                <option value="full">Full Disbursement</option>
                                <option value="partial">Partial Disbursement</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <input type="number" class="form-control" id="trancheNumber" name="tranche_number" placeholder="Tranche number" value="1" required>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" id="disbursementNotes" name="notes" rows="2" placeholder="Disbursement notes..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-cash-stack me-2"></i>Create Disbursement
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Disbursement History -->
            {% if assignment and assignment.status in ['approved', 'disbursed'] %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>Disbursement History
                    </h5>
                </div>
                <div class="card-body">
                    <div id="disbursementHistory">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Lead Modal -->
{% if can_update_lead %}
<div class="modal fade" id="editLeadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>Edit Lead Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editLeadForm" action="#" method="POST" novalidate onsubmit="return false;">
                <div class="modal-body">
                    <!-- Basic Information Tab -->
                    <ul class="nav nav-tabs mb-3" id="editLeadTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                <i class="bi bi-person me-1"></i>Basic Info
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="loan-tab" data-bs-toggle="tab" data-bs-target="#loan" type="button" role="tab">
                                <i class="bi bi-cash-coin me-1"></i>Loan Details
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="additional-tab" data-bs-toggle="tab" data-bs-target="#additional" type="button" role="tab">
                                <i class="bi bi-info-circle me-1"></i>Additional
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="editLeadTabContent">
                        <!-- Basic Information Tab -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Name *</label>
                                    <input type="text" class="form-control" name="name" value="{{ lead.name }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Contact *</label>
                                    <input type="tel" class="form-control" name="contact" value="{{ lead.contact }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" name="email" value="{{ lead.email or '' }}" placeholder="Enter email address">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" name="city" value="{{ lead.city or '' }}" placeholder="Enter city">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Occupation</label>
                                    <select class="form-select" name="occupation">
                                        <option value="">Select Occupation</option>
                                        <option value="salaried" {% if lead.occupation == 'salaried' %}selected{% endif %}>Salaried</option>
                                        <option value="self-employed" {% if lead.occupation == 'self-employed' %}selected{% endif %}>Self Employed</option>
                                        <option value="business-owner" {% if lead.occupation == 'business-owner' %}selected{% endif %}>Business Owner</option>
                                        <option value="professional" {% if lead.occupation == 'professional' %}selected{% endif %}>Professional</option>
                                        <option value="student" {% if lead.occupation == 'student' %}selected{% endif %}>Student</option>
                                        <option value="retired" {% if lead.occupation == 'retired' %}selected{% endif %}>Retired</option>
                                        <option value="other" {% if lead.occupation and lead.occupation not in ['salaried', 'self-employed', 'business-owner', 'professional', 'student', 'retired'] %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6" id="occupationOtherField" style="display: none;">
                                    <label class="form-label">Other Occupation</label>
                                    <input type="text" class="form-control" name="occupation_other" value="{% if lead.occupation and lead.occupation not in ['salaried', 'self-employed', 'business-owner', 'professional', 'student', 'retired'] %}{{ lead.occupation }}{% endif %}" placeholder="Specify occupation">
                                </div>
                            </div>
                        </div>

                        <!-- Loan Details Tab -->
                        <div class="tab-pane fade" id="loan" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Loan Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" class="form-control" name="loan_amount" value="{{ lead.loan_amount or '' }}" step="1000" placeholder="Enter loan amount">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Loan Type</label>
                                    <select class="form-select" name="loan_type">
                                        <option value="">Select Loan Type</option>
                                        <option value="personal" {% if lead.loan_type == 'personal' %}selected{% endif %}>Personal Loan</option>
                                        <option value="business" {% if lead.loan_type == 'business' %}selected{% endif %}>Business Loan</option>
                                        <option value="home" {% if lead.loan_type == 'home' %}selected{% endif %}>Home Loan</option>
                                        <option value="vehicle" {% if lead.loan_type == 'vehicle' %}selected{% endif %}>Vehicle Loan</option>
                                        <option value="education" {% if lead.loan_type == 'education' %}selected{% endif %}>Education Loan</option>
                                        <option value="property" {% if lead.loan_type == 'property' %}selected{% endif %}>Property Loan</option>
                                        <option value="gold" {% if lead.loan_type == 'gold' %}selected{% endif %}>Gold Loan</option>
                                        <option value="other" {% if lead.loan_type and lead.loan_type not in ['personal', 'business', 'home', 'vehicle', 'education', 'property', 'gold'] %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ongoing Loans</label>
                                    <select class="form-select" name="any_ongoing_loan">
                                        <option value="">Select</option>
                                        <option value="yes" {% if lead.any_ongoing_loan == 'yes' %}selected{% endif %}>Yes</option>
                                        <option value="no" {% if lead.any_ongoing_loan == 'no' %}selected{% endif %}>No</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Monthly Income</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" class="form-control" name="monthly_income" value="{{ lead.additional_data.monthly_income if lead.additional_data and lead.additional_data.monthly_income else '' }}" step="1000" placeholder="Enter monthly income">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Credit Score</label>
                                    <input type="number" class="form-control" name="credit_score" value="{{ lead.additional_data.credit_score if lead.additional_data and lead.additional_data.credit_score else '' }}" min="300" max="900" placeholder="Enter credit score">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Employment Type</label>
                                    <select class="form-select" name="employment_type">
                                        <option value="">Select Type</option>
                                        <option value="permanent" {% if lead.additional_data and lead.additional_data.employment_type == 'permanent' %}selected{% endif %}>Permanent</option>
                                        <option value="contract" {% if lead.additional_data and lead.additional_data.employment_type == 'contract' %}selected{% endif %}>Contract</option>
                                        <option value="freelance" {% if lead.additional_data and lead.additional_data.employment_type == 'freelance' %}selected{% endif %}>Freelance</option>
                                        <option value="part-time" {% if lead.additional_data and lead.additional_data.employment_type == 'part-time' %}selected{% endif %}>Part-time</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information Tab -->
                        <div class="tab-pane fade" id="additional" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Message/Notes</label>
                                    <textarea class="form-control" name="message" rows="3" placeholder="Enter any message or notes from the lead...">{{ lead.message or '' }}</textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Other Details</label>
                                    <textarea class="form-control" name="other_details" rows="3" placeholder="Add any additional details, notes, or information...">{{ lead.other_details or '' }}</textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Preferred Contact Time</label>
                                    <select class="form-select" name="preferred_contact_time">
                                        <option value="">Select Time</option>
                                        <option value="morning" {% if lead.additional_data and lead.additional_data.preferred_contact_time == 'morning' %}selected{% endif %}>Morning (9 AM - 12 PM)</option>
                                        <option value="afternoon" {% if lead.additional_data and lead.additional_data.preferred_contact_time == 'afternoon' %}selected{% endif %}>Afternoon (12 PM - 5 PM)</option>
                                        <option value="evening" {% if lead.additional_data and lead.additional_data.preferred_contact_time == 'evening' %}selected{% endif %}>Evening (5 PM - 8 PM)</option>
                                        <option value="anytime" {% if lead.additional_data and lead.additional_data.preferred_contact_time == 'anytime' %}selected{% endif %}>Anytime</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Lead Source Details</label>
                                    <input type="text" class="form-control" name="source_details" value="{{ lead.additional_data.source_details if lead.additional_data and lead.additional_data.source_details else '' }}" placeholder="e.g., Google Ads, Facebook, Referral, etc.">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                    <button type="button" class="btn btn-primary" onclick="submitForm()">
                        <i class="bi bi-check-circle me-2"></i>Update Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Assign Lead Modal -->
<div class="modal fade" id="assignLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus me-2"></i>Assign Lead
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignLeadForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Employee *</label>
                        <select class="form-select" name="employee_id" required>
                            <option value="">Choose an employee...</option>
                            {% for employee in employees %}
                            <option value="{{ employee.employee_id }}">{{ employee.user.name }} ({{ employee.employee_code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assignment Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Add any notes about this assignment..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Assign Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reassign Lead Modal -->
{% if assignment %}
<div class="modal fade" id="reassignLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat me-2"></i>Reassign Lead
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reassignLeadForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Currently assigned to:</strong> {{ assignment.employee.user.name }} ({{ assignment.employee.employee_code }})
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select New Employee *</label>
                        <select class="form-select" name="employee_id" required>
                            <option value="">Choose an employee...</option>
                            {% for employee in employees %}
                            {% if employee.employee_id != assignment.employee_id %}
                            <option value="{{ employee.employee_id }}">{{ employee.user.name }} ({{ employee.employee_code }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reassignment Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Add notes about why this lead is being reassigned..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-repeat me-2"></i>Reassign Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Edit Other Details Modal -->
{% if assignment %}
<div class="modal fade" id="editOtherDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text me-2"></i>Edit Other Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editOtherDetailsForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Additional Details</label>
                        <textarea class="form-control" name="other_details" rows="6" placeholder="Add any additional details, notes, or information about this lead...">{{ lead.other_details or '' }}</textarea>
                        <div class="form-text">Use this field to add any manual information, notes, or additional details about the lead.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Save Details
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function refreshTree() {
    // Force a page refresh to get the latest data
    location.reload();
}

// Auto-refresh the tree every 30 seconds to ensure it's up to date
setInterval(function() {
    const treeContainer = document.querySelector('.workflow-progress');
    if (treeContainer) {
        const currentStatus = treeContainer.getAttribute('data-status');
        
        // If the status is 'closed' but the tree doesn't show it as current, force refresh
        if (currentStatus === 'closed') {
            const closedStep = document.querySelector('.progress-step[data-status="closed"]');
            if (closedStep && !closedStep.classList.contains('current')) {
                location.reload();
            }
        }
    }
}, 30000);

// Force refresh on page load if cache is stale
window.addEventListener('load', function() {
    const treeContainer = document.querySelector('.workflow-progress');
    if (treeContainer) {
        const currentStatus = treeContainer.getAttribute('data-status');
        const cacheBuster = treeContainer.getAttribute('data-cache-buster');
    }
});
</script>
<style>
/* Remove conflicting progress-tree styles and use the enhanced tree from base.html */
.comment-item {
    transition: all 0.3s ease;
}

.comment-item:hover {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.5rem;
    margin: -0.5rem;
}

/* Fix decision container layout */
.decision-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin: 1rem 0;
    position: relative;
    width: 100%;
}

.decision-branch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.decision-line {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: #e2e8f0;
    z-index: 0;
    transform: translateY(-50%);
}

.decision-line.completed {
    background: var(--success-color);
}

/* Ensure proper spacing for decision branches */
.decision-branch .progress-step {
    min-width: 100px;
    max-width: 120px;
    margin: 0 auto;
}

/* Fix connector positioning */
.progress-connector {
    position: relative;
    width: 2px;
    height: 1.5rem;
    background: #e2e8f0;
    margin: 0.25rem auto;
    z-index: 1;
}

.progress-connector.completed {
    background: var(--success-color);
}

/* Decision flow styling */
.decision-flow {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px solid #e2e8f0;
}

.decision-split {
    position: relative;
    text-align: center;
    margin-bottom: 1rem;
}

.decision-line {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background: #e2e8f0;
    z-index: 0;
}

.decision-label {
    background: white;
    padding: 0 1rem;
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    position: relative;
    z-index: 1;
}

.decision-branches {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    margin-top: 1rem;
}

.branch {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.branch-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.approved-branch .branch-label {
    color: #059669;
}

.rejected-branch .branch-label {
    color: #dc2626;
}

/* JIRA-style Activity Log */
.jira-activity-log {
    padding: 0;
    margin: 0;
}

.activity-item {
    position: relative;
    padding: 16px 20px;
    border-bottom: 1px solid #f1f3f4;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(10px);
}

.activity-item:hover {
    background-color: #f8f9fa;
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-timeline {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.activity-avatar {
    flex-shrink: 0;
    margin-top: 2px;
}

.avatar-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.avatar-circle.system {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    font-size: 12px;
}

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.activity-meta {
    display: flex;
    align-items: center;
    gap: 4px;
}

.activity-user {
    font-weight: 600;
    color: #172b4d;
    font-size: 14px;
}

.activity-action {
    color: #5e6c84;
    font-size: 14px;
}

.activity-time {
    color: #6b778c;
    font-size: 12px;
    font-weight: 400;
}

.activity-body {
    margin-left: 0;
}

.activity-description {
    color: #172b4d;
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 8px;
}

.activity-details {
    background: #f4f5f7;
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    border-left: 3px solid #dee2e6;
}

.activity-field {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
    font-size: 13px;
}

.activity-field:last-child {
    margin-bottom: 0;
}

.field-label {
    font-weight: 600;
    color: #5e6c84;
    min-width: 120px;
    margin-right: 8px;
}

.field-value {
    color: #172b4d;
    background: white;
    padding: 2px 6px;
    border-radius: 3px;
    border: 1px solid #dfe1e6;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 12px;
}

.activity-comment {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    margin: 8px 0;
    position: relative;
}

.activity-comment::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 12px;
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid #e9ecef;
}

.comment-content {
    color: #172b4d;
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-wrap;
}

/* Status change specific styling */
.activity-item[data-activity-type="status_changed"] .activity-details {
    border-left-color: #0052cc;
}

.activity-item[data-activity-type="comment_added"] .activity-comment {
    border-left: 3px solid #36b37e;
}

.activity-item[data-activity-type="assigned"] .activity-details {
    border-left-color: #ff5630;
}

.activity-item[data-activity-type="created"] .activity-details {
    border-left-color: #36b37e;
}

/* Animation for activity items */
.activity-item.fade-in {
    opacity: 1;
    transform: translateY(0);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .activity-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .activity-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
    
    .field-label {
        min-width: 100px;
    }
    
    .activity-item:hover {
        transform: none;
    }
}
</style>

<script>
    // Load disbursement history
    function loadDisbursementHistory() {
        const historyContainer = document.getElementById('disbursementHistory');
        if (!historyContainer) return;
        
        fetch(`/crm/assignments/{{ assignment.assignment_id }}/disbursements`)
            .then(response => response.json())
            .then(data => {
                if (data.disbursements && data.disbursements.length > 0) {
                    let html = '<div class="list-group list-group-flush">';
                    data.disbursements.forEach(disbursement => {
                        html += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>₹${disbursement.amount.toLocaleString()}</strong>
                                    <br><small class="text-muted">${disbursement.disbursement_type} - Tranche ${disbursement.tranche_number}</small>
                                    ${disbursement.notes ? `<br><small>${disbursement.notes}</small>` : ''}
                                </div>
                                <small class="text-muted">${new Date(disbursement.disbursement_date).toLocaleDateString()}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += `<div class="mt-3 text-end"><strong>Total: ₹${data.total_disbursed.toLocaleString()}</strong></div>`;
                    historyContainer.innerHTML = html;
                } else {
                    historyContainer.innerHTML = '<p class="text-muted text-center">No disbursements yet</p>';
                }
            })
            .catch(error => {
                console.error('Error loading disbursement history:', error);
                historyContainer.innerHTML = '<p class="text-danger text-center">Error loading disbursement history</p>';
            });
    }

    // Add comment
    document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const commentText = document.getElementById('commentText').value;
        
        const url = `/crm/unified-leads/{{ lead.lead_id }}/add-comment`;
        const body = `comment=${encodeURIComponent(commentText)}`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the comment.');
        });
    });

    // Delete comment
    function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;
        
        fetch(`/crm/comments/${commentId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the comment.');
        });
    }

    // Show/hide close type selection based on status selection
    document.getElementById('newStatus').addEventListener('change', function() {
        const closeTypeSection = document.getElementById('closeTypeSection');
        const closeTypeSelect = document.getElementById('closeType');
        
        if (this.value === 'closed') {
            closeTypeSection.style.display = 'block';
            closeTypeSelect.required = true;
        } else {
            closeTypeSection.style.display = 'none';
            closeTypeSelect.required = false;
            closeTypeSelect.value = '';
        }
    });

    // Update status
    document.getElementById('statusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const newStatus = document.getElementById('newStatus').value;
        const comment = document.getElementById('statusComment').value;
        const closeType = document.getElementById('closeType').value;
        
        if (!newStatus) {
            alert('Please select a new status');
            return;
        }
        
        if (newStatus === 'closed' && !closeType) {
            alert('Please select a closure reason when closing the lead');
            return;
        }
        
        const url = `/crm/unified-leads/assignment/{{ assignment.assignment_id }}/update-status`;
        let body = `new_status=${encodeURIComponent(newStatus)}&comment=${encodeURIComponent(comment)}`;
        if (closeType) {
            body += `&close_type=${encodeURIComponent(closeType)}`;
        }
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the status.');
        });
    });



    // Set PD amount
    document.getElementById('pdAmountForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const amount = document.getElementById('pdAmount').value;
        
        fetch(`/crm/assignments/{{ assignment.assignment_id }}/update-pd-amount`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `amount=${encodeURIComponent(amount)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the PD amount.');
        });
    });

    // Create disbursement
    document.getElementById('disbursementForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        formData.append('disbursement_date', new Date().toISOString());
        
        fetch(`/crm/assignments/{{ assignment.assignment_id }}/disburse`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while creating the disbursement.');
        });
    });

        // Edit lead form - moved inside DOMContentLoaded
    function setupEditForm() {
        console.log('Edit form setup completed');
    }

    // Assign lead form
    document.getElementById('assignLeadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`/crm/unified-leads/{{ lead.lead_id }}/assign`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while assigning the lead.');
        });
    });

    // Reassign lead form
    {% if assignment %}
    document.getElementById('reassignLeadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`/crm/unified-leads/{{ lead.lead_id }}/reassign`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while reassigning the lead.');
        });
    });
    {% endif %}

    // Edit other details form
    {% if assignment %}
    document.getElementById('editOtherDetailsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`/crm/unified-leads/{{ lead.lead_id }}/update-other-details`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the details.');
        });
    });
    {% endif %}



    // Direct form submission function
    function submitForm() {
        console.log('Submit form function called');
        const editForm = document.getElementById('editLeadForm');
        if (!editForm) {
            alert('Form not found!');
            return;
        }
        
        console.log('Form found, collecting data...');
        const formData = new FormData(editForm);
        
        // Log form data for debugging
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
            console.log(key + ': ' + value);
        }
        
        console.log('Sending request to server...');
        fetch(`/crm/unified-leads/{{ lead.lead_id }}/update`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response received:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            if (data.success) {
                alert('Lead updated successfully!');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the lead: ' + error.message);
        });
    }

    // Priority toggle function
    function togglePriority() {
        const button = document.getElementById('togglePriorityBtn');
        const priorityText = document.getElementById('priorityText');
        const currentPriority = priorityText.textContent.trim();
        const newPriority = currentPriority === 'Doable' ? 'not_doable' : 'doable';
        
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Updating...';
        
        fetch(`/crm/unified-leads/{{ lead.lead_id }}/toggle-priority`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                priority: newPriority
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button text
                priorityText.textContent = newPriority === 'doable' ? 'Doable' : 'Not Doable';
                
                // Update button styling
                if (newPriority === 'doable') {
                    button.classList.remove('btn-outline-secondary');
                    button.classList.add('btn-outline-success');
                } else {
                    button.classList.remove('btn-outline-success');
                    button.classList.add('btn-outline-secondary');
                }
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>Priority updated successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
                
                // Auto-remove alert after 3 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the priority.');
        })
        .finally(() => {
            // Restore button state
            button.disabled = false;
            button.innerHTML = `<i class="bi bi-flag me-1"></i><span id="priorityText">${newPriority === 'doable' ? 'Doable' : 'Not Doable'}</span>`;
        });
    }

    // Initialize JIRA-style activity log
    function initializeActivityLog() {
        const activityItems = document.querySelectorAll('.activity-item');
        
        activityItems.forEach((item, index) => {
            // Add animation delay for staggered appearance
            item.style.animationDelay = `${index * 0.1}s`;
            item.classList.add('fade-in');
            
            // Add hover effects
            item.addEventListener('mouseenter', function() {
                this.style.transform = 'translateX(4px)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
            });
            
            // Add click to expand/collapse details
            const details = item.querySelector('.activity-details');
            if (details) {
                const header = item.querySelector('.activity-header');
                if (header) {
                    header.style.cursor = 'pointer';
                    header.addEventListener('click', function() {
                        details.style.display = details.style.display === 'none' ? 'block' : 'none';
                    });
                }
            }
        });
        
        // Add relative time formatting
        updateRelativeTimes();
    }
    
    // Update relative times (like "2 hours ago")
    function updateRelativeTimes() {
        const timeElements = document.querySelectorAll('.activity-time time');
        
        timeElements.forEach(element => {
            const dateTime = element.getAttribute('datetime');
            if (dateTime) {
                const date = new Date(dateTime);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let relativeTime;
                if (diffMins < 1) {
                    relativeTime = 'just now';
                } else if (diffMins < 60) {
                    relativeTime = `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
                } else if (diffHours < 24) {
                    relativeTime = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else if (diffDays < 7) {
                    relativeTime = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else {
                    relativeTime = date.toLocaleDateString();
                }
                
                element.textContent = relativeTime;
            }
        });
    }
    
    // Initialize collapsible sections
    function initializeCollapsibleSections() {
        const optionalFieldsToggle = document.getElementById('optionalFields');
        const optionalFieldsIcon = document.getElementById('optionalFieldsIcon');
        
        if (optionalFieldsToggle && optionalFieldsIcon) {
            optionalFieldsToggle.addEventListener('show.bs.collapse', function () {
                optionalFieldsIcon.classList.remove('bi-chevron-right');
                optionalFieldsIcon.classList.add('bi-chevron-down');
            });
            
            optionalFieldsToggle.addEventListener('hide.bs.collapse', function () {
                optionalFieldsIcon.classList.remove('bi-chevron-down');
                optionalFieldsIcon.classList.add('bi-chevron-right');
            });
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        
        {% if assignment and assignment.status in ['approved', 'disbursed'] %}
        loadDisbursementHistory();
        {% endif %}
        
        // Initialize JIRA-style activity log
        initializeActivityLog();
        
        // Initialize collapsible sections
        initializeCollapsibleSections();
        
        // Set initial button styling based on priority
        const priorityText = document.getElementById('priorityText');
        const button = document.getElementById('togglePriorityBtn');
        if (priorityText && button) {
            if (priorityText.textContent.trim() === 'Doable') {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-success');
            }
        }

        // Handle occupation field logic
        const occupationSelect = document.querySelector('select[name="occupation"]');
        const occupationOtherField = document.getElementById('occupationOtherField');
        const occupationOther = document.querySelector('input[name="occupation_other"]');
        
        if (occupationSelect && occupationOtherField && occupationOther) {
            occupationSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    occupationOtherField.style.display = 'block';
                    occupationOther.required = true;
                } else {
                    occupationOtherField.style.display = 'none';
                    occupationOther.required = false;
                    occupationOther.value = '';
                }
            });
            
            // Set initial state
            if (occupationSelect.value === 'other') {
                occupationOtherField.style.display = 'block';
                occupationOther.required = true;
            } else {
                occupationOtherField.style.display = 'none';
                occupationOther.required = false;
            }
        }
        

        
        // Setup edit form event listener
        setupEditForm();
        

    });
</script>

<!-- Close Lead Modal -->
<div class="modal fade" id="closeLeadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-archive me-2"></i>Close Lead
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="closeLeadForm">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action will permanently close the lead and move it to closed cases.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Close Type *</label>
                        <select class="form-select" name="close_type" required>
                            <option value="">Select close type...</option>
                            <option value="success">Closed - Success</option>
                            <option value="not_doable">Closed - Not Doable</option>
                        </select>
                        <small class="text-muted">
                            <strong>Success:</strong> Lead was successfully processed and completed<br>
                            <strong>Not Doable:</strong> Lead could not be processed for various reasons
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Close Reason *</label>
                        <textarea class="form-control" name="close_reason" rows="4" required placeholder="Please provide a detailed reason for closing this lead..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-archive me-2"></i>Close Lead
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Close Lead Form JavaScript -->
<script>
    document.getElementById('closeLeadForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!confirm('Are you sure you want to close this lead? This action cannot be undone.')) {
            return;
        }
        
        const formData = new FormData(this);
        
        console.log('Submitting close lead form...');
        console.log('Form data:', Object.fromEntries(formData));
        
        fetch(`/crm/leads/{{ lead.lead_id }}/close`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                alert('Lead closed successfully!');
                window.location.href = '/crm/close-leads';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while closing the lead: ' + error.message);
        });
    });
</script>
{% endblock %}

